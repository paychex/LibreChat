name: N2A - Build and Push

env:
    # Azure ACR
    ACR_HOST: ${{ vars.REGISTRY_LOGIN_SERVER_PROD }}
    ACR_USER: ${{ secrets.REGISTRY_USERNAME_PROD }}
    ACR_PASS: ${{ secrets.REGISTRY_PASSWORD_PROD }}

on:
  # Automated deploy on push to main branch
  push:
    branches:
      - main
  # Manual trigger
  workflow_dispatch:
      inputs:
          build_rag_api_image:
            description: 'Build RAG API Docker Image'
            required: true
            default: true
            type: boolean
          branch:
            description: 'Branch to build'
            required: true
            default: ''
            type: string

permissions:
  id-token: write

jobs:
    # Build job - can run in parallel (each builds its own commit)
    build:
        name: Build Docker Image
        runs-on: paychex-ai-platform-arc-nonprod
        outputs:
          commit_sha: ${{ steps.commit_sha.outputs.sha }}
        steps:
            - uses: actions/checkout@v3
              with:
                fetch-depth: 0 # fetch all branches and tags
                ref: ${{ github.event.inputs.branch || github.ref }}

            - name: Get commit SHA
              id: commit_sha
              run: |
                SHA=$(git rev-parse HEAD)
                echo "sha=$SHA" >> $GITHUB_OUTPUT
                echo "COMMIT_SHA=$SHA" >> $GITHUB_ENV

            - name: Create Config File
              run: |
                touch librechat.yaml && chmod 755 librechat.yaml |
                cat librechat.n2a.yml >> librechat.yaml |
                rm -rf .dockerignore |
                touch .dockerignore && chmod 755 .dockerignore |
                cat .paychex.dockerignore >> .dockerignore

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: log in to ACR
              uses: azure/docker-login@v1
              with:
                login-server: ${{ env.ACR_HOST }}
                username: ${{ env.ACR_USER }}
                password: ${{ env.ACR_PASS }}

            - name: Build and push docker container
              uses: docker/build-push-action@v5
              with:
                context: .
                push: true
                tags: |
                  ${{ env.ACR_HOST }}/paychex/librechat:n2a.${{ env.COMMIT_SHA }}
                  ${{ env.ACR_HOST }}/paychex/librechat:n2a.latest

            - name: Trigger rag_api Workflow (async)
              if: ${{ github.event.inputs.build_rag_api_image != 'false' }}
              env:
                GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
              run: |
                # Fire-and-forget: trigger RAG API build without waiting
                # Uses official GitHub REST API: https://docs.github.com/en/rest/actions/workflows#create-a-workflow-dispatch-event
                curl -X POST \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "https://api.github.com/repos/paychex/rag_api/actions/workflows/n2-build-and-push.yml/dispatches" \
                  -d '{"ref":"main"}' \
                  --fail --silent --show-error
                echo "âœ“ RAG API workflow triggered (async)"

    # Deploy job - serialized with concurrency control to prevent race conditions
    deploy:
        name: Deploy to N2A
        needs: build
        runs-on: paychex-ai-platform-arc-nonprod
        # Ensures only one deploy runs at a time, queuing others in order
        concurrency:
          group: n2a-deploy
          cancel-in-progress: false
        steps:
            - uses: actions/checkout@v3
              with:
                fetch-depth: 0
                ref: ${{ github.event.inputs.branch || github.ref }}

            - name: Update librechat image in YAML
              uses: mikefarah/yq@master
              with:
                cmd: yq -i '.properties.template.containers[] |= select(.name == "conpaichat").image = "${{ env.ACR_HOST }}/paychex/librechat:n2a.${{ needs.build.outputs.commit_sha }}"' az_container_app_definitions/n2a_container_app_definition.yml
                    
            - name: Azure CLI script
              uses: azure/cli@v2
              with:
                  inlineScript: |
                    az login --service-principal -u ${{secrets.ARC_RUNNER_SP_CLIENT_ID_NONPROD}} -p ${{secrets.ARC_RUNNER_SP_CLIENT_SECRET_NONPROD}} --tenant ${{secrets.AZURE_TENANT_ID}}
                    az account set --subscription "${{ secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}"
                    az containerapp create \
                      --name conpaichateastusn2a001 \
                      --resource-group rg-playai-eastus-n2a-001 \
                      --yaml $GITHUB_WORKSPACE/az_container_app_definitions/n2a_container_app_definition.yml
