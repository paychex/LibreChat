name: Terraform Infrastructure

# =============================================================================
# ROLLOUT STATUS:
#   ‚úÖ sandbox  - Ready for Terraform management
#   ‚úÖ n2a      - Ready for Terraform management (parallel deployment)
#   ‚è≥ n1       - Existing infra, import required before Terraform management  
#   ‚è≥ prod     - Existing infra, import required before Terraform management
#
# To enable additional environments:
#   1. Import existing resources: terraform import ...
#   2. Add environment to the 'options' list below
#   3. Test with 'plan' action first
# =============================================================================

on:
  pull_request:
    branches:
      - main
    paths:
      - 'infrastructure/terraform/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - sandbox
          - n2a
          # Uncomment below after importing existing infrastructure:
          # - n1
          # - prod

concurrency:
  group: terraform-${{ github.event.inputs.environment || 'ci' }}-${{ github.ref }}
  cancel-in-progress: false

env:
  TF_VERSION: '1.9.8'
  TF_WORKING_DIR: './infrastructure/terraform'
  # ARC runners use managed identity - no OIDC config needed

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  # ============================================================================
  # VALIDATION - Runs on all PRs
  # ============================================================================
  validate:
    name: Validate
    runs-on: paychex-ai-platform-arc-sandbox
    outputs:
      environments: ${{ steps.set-matrix.outputs.environments }}
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Format Check
        run: terraform fmt -check -recursive

      - name: Init (validation only)
        run: terraform init -backend=false

      - name: Validate
        run: terraform validate

      - name: Set Environment Matrix
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo 'environments=["${{ github.event.inputs.environment }}"]' >> $GITHUB_OUTPUT
          else
            # Only plan sandbox on PRs until other environments are imported
            echo 'environments=["sandbox"]' >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # PLAN - Generates plan for review (PRs plan all envs, manual plans single)
  # ============================================================================
  plan:
    name: Plan (${{ matrix.environment }})
    needs: validate
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
    runs-on: ${{ matrix.environment == 'sandbox' && 'paychex-ai-platform-arc-sandbox' || (matrix.environment == 'prod' && 'paychex-ai-platform-arc-prod' || 'paychex-ai-platform-arc-nonprod') }}
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJSON(needs.validate.outputs.environments) }}
    environment: ${{ matrix.environment }}-plan
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}
    env:
      # Map environment to subscription credentials
      ARM_SUBSCRIPTION_ID: ${{ matrix.environment == 'n2a' && secrets.AZURE_NONPROD_SUBSCRIPTION_ID || secrets.AZURE_SANDBOX_SUBSCRIPTION_ID }}
      ARM_CLIENT_ID: ${{ matrix.environment == 'n2a' && secrets.ARC_RUNNER_SP_CLIENT_ID_NONPROD || secrets.ARC_RUNNER_SP_CLIENT_ID_SANDBOX }}
      ARM_CLIENT_SECRET: ${{ matrix.environment == 'n2a' && secrets.ARC_RUNNER_SP_CLIENT_SECRET_NONPROD || secrets.ARC_RUNNER_SP_CLIENT_SECRET_SANDBOX }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      TF_VAR_subscription_id: ${{ matrix.environment == 'n2a' && secrets.AZURE_NONPROD_SUBSCRIPTION_ID || secrets.AZURE_SANDBOX_SUBSCRIPTION_ID }}
      # First deploy flag - defaults to false (production-safe), set <ENV>_FIRST_DEPLOY=true to enable relaxed settings
      TF_VAR_first_deploy: ${{ (matrix.environment == 'sandbox' && vars.SANDBOX_FIRST_DEPLOY == 'true') || (matrix.environment == 'n2a' && vars.N2A_FIRST_DEPLOY == 'true') || (matrix.environment == 'n1' && vars.N1_FIRST_DEPLOY == 'true') || (matrix.environment == 'prod' && vars.PROD_FIRST_DEPLOY == 'true') }}
      # Paychex tags - from GitHub repository variables
      TF_VAR_payx_owner: ${{ vars.PAYX_OWNER }}
      TF_VAR_payx_servicenow_group: ${{ vars.PAYX_SERVICENOW_GROUP }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/cli@v2
        with:
          inlineScript: |
            if [ "${{ matrix.environment }}" == "n2a" ]; then
              az login --service-principal -u ${{ secrets.ARC_RUNNER_SP_CLIENT_ID_NONPROD }} -p ${{ secrets.ARC_RUNNER_SP_CLIENT_SECRET_NONPROD }} --tenant ${{ secrets.AZURE_TENANT_ID }}
              az account set --subscription "${{ secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}"
            else
              az login --service-principal -u ${{ secrets.ARC_RUNNER_SP_CLIENT_ID_SANDBOX }} -p ${{ secrets.ARC_RUNNER_SP_CLIENT_SECRET_SANDBOX }} --tenant ${{ secrets.AZURE_TENANT_ID }}
              az account set --subscription "${{ secrets.AZURE_SANDBOX_SUBSCRIPTION_ID }}"
            fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure Backend
        env:
          SANDBOX_SUB: ${{ secrets.AZURE_SANDBOX_SUBSCRIPTION_ID }}
          NONPROD_SUB: ${{ secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}
          PROD_SUB: ${{ secrets.AZURE_PROD_SUBSCRIPTION_ID }}
        run: |
          case "${{ matrix.environment }}" in
            sandbox)
              echo "TF_BACKEND_RG=rg-paychexai-tf-eastus-sandbox-001" >> $GITHUB_ENV
              echo "TF_BACKEND_SA=sapaychexaitfsb001" >> $GITHUB_ENV
              echo "TF_BACKEND_SUB=$SANDBOX_SUB" >> $GITHUB_ENV
              ;;
            n2a|n1)
              echo "TF_BACKEND_RG=rg-paychexai-tf-eastus-nonprod-001" >> $GITHUB_ENV
              echo "TF_BACKEND_SA=sapaychexaitfnonprod001" >> $GITHUB_ENV
              echo "TF_BACKEND_SUB=$NONPROD_SUB" >> $GITHUB_ENV
              ;;
            prod)
              echo "TF_BACKEND_RG=rg-paychexai-tf-eastus-prod-001" >> $GITHUB_ENV
              echo "TF_BACKEND_SA=sapaychexaitfprod001" >> $GITHUB_ENV
              echo "TF_BACKEND_SUB=$PROD_SUB" >> $GITHUB_ENV
              ;;
          esac

      - name: Init
        run: |
          terraform init \
            -backend-config="resource_group_name=$TF_BACKEND_RG" \
            -backend-config="storage_account_name=$TF_BACKEND_SA" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=librechat/${{ matrix.environment }}.tfstate" \
            -backend-config="subscription_id=$TF_BACKEND_SUB"

      - name: Plan
        id: plan
        run: |
          set +e
          terraform plan \
            -var-file=environments/${{ matrix.environment }}.tfvars \
            -out=${{ matrix.environment }}.tfplan \
            -detailed-exitcode \
            -no-color 2>&1 | tee plan_output.txt
          exit_code=$?
          set -e

          # Exit code 2 means changes, 0 means no changes, 1 means error
          if [ "$exit_code" == "1" ]; then
            echo "has_changes=error" >> $GITHUB_OUTPUT
            exit 1
          elif [ "$exit_code" == "2" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.environment }}
          path: |
            ${{ env.TF_WORKING_DIR }}/${{ matrix.environment }}.tfplan
            ${{ env.TF_WORKING_DIR }}/plan_output.txt
          retention-days: 7

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planPath = '${{ env.TF_WORKING_DIR }}/plan_output.txt';
            let planOutput = '';

            try {
              planOutput = fs.readFileSync(planPath, 'utf8');
            } catch (e) {
              planOutput = 'Unable to read plan output';
            }

            const truncated = planOutput.length > 60000 
              ? planOutput.substring(0, 60000) + '\n\n... (truncated)'
              : planOutput;

            const hasChanges = '${{ steps.plan.outputs.has_changes }}';
            const icon = hasChanges === 'true' ? 'üîÑ' : (hasChanges === 'false' ? '‚úÖ' : '‚ùå');

            const body = [
              `### ${icon} Terraform Plan - \`${{ matrix.environment }}\``,
              '',
              `**Changes Detected:** ${hasChanges === 'true' ? 'Yes' : (hasChanges === 'false' ? 'No changes' : 'Error')}`,
              '',
              '<details><summary>Show Plan Output</summary>',
              '',
              '```hcl',
              truncated,
              '```',
              '',
              '</details>',
              '',
              '---',
              '*Triggered by @${{ github.actor }}*'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================================================
  # BLOCK NOTICE - Shows when apply is attempted on locked environments
  # ============================================================================
  apply-blocked:
    name: Apply Blocked (${{ github.event.inputs.environment }})
    needs: validate
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'apply' &&
      github.event.inputs.environment != 'sandbox' &&
      github.event.inputs.environment != 'n2a'
    runs-on: paychex-ai-platform-arc-sandbox
    steps:
      - name: Block Apply
        run: |
          echo "::error::Apply is currently blocked for ${{ github.event.inputs.environment }}."
          echo "::notice::Only 'plan' action is available until existing infrastructure is imported."
          echo ""
          echo "To enable apply for ${{ github.event.inputs.environment }}:"
          echo "  1. Import existing resources: terraform import ..."
          echo "  2. Update workflow to allow apply for this environment"
          exit 1

  # ============================================================================
  # APPLY - Manual deployment
  # ============================================================================
  deploy:
    name: Apply (${{ github.event.inputs.environment }})
    needs: validate
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'apply' &&
      (github.event.inputs.environment == 'sandbox' || github.event.inputs.environment == 'n2a')
    runs-on: ${{ github.event.inputs.environment == 'sandbox' && 'paychex-ai-platform-arc-sandbox' || (github.event.inputs.environment == 'prod' && 'paychex-ai-platform-arc-prod' || 'paychex-ai-platform-arc-nonprod') }}
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ steps.get_url.outputs.url }}
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}
    env:
      # Credentials mapped per environment
      ARM_SUBSCRIPTION_ID: ${{ github.event.inputs.environment == 'sandbox' && secrets.AZURE_SANDBOX_SUBSCRIPTION_ID || secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}
      ARM_CLIENT_ID: ${{ github.event.inputs.environment == 'sandbox' && secrets.ARC_RUNNER_SP_CLIENT_ID_SANDBOX || secrets.ARC_RUNNER_SP_CLIENT_ID_NONPROD }}
      ARM_CLIENT_SECRET: ${{ github.event.inputs.environment == 'sandbox' && secrets.ARC_RUNNER_SP_CLIENT_SECRET_SANDBOX || secrets.ARC_RUNNER_SP_CLIENT_SECRET_NONPROD }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      TF_VAR_subscription_id: ${{ github.event.inputs.environment == 'sandbox' && secrets.AZURE_SANDBOX_SUBSCRIPTION_ID || secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}
      # First deploy flag - defaults to false (production-safe), set <ENV>_FIRST_DEPLOY=true to enable relaxed settings
      TF_VAR_first_deploy: ${{ (github.event.inputs.environment == 'sandbox' && vars.SANDBOX_FIRST_DEPLOY == 'true') || (github.event.inputs.environment == 'n2a' && vars.N2A_FIRST_DEPLOY == 'true') || (github.event.inputs.environment == 'n1' && vars.N1_FIRST_DEPLOY == 'true') || (github.event.inputs.environment == 'prod' && vars.PROD_FIRST_DEPLOY == 'true') }}
      # Paychex tags - from GitHub repository variables
      TF_VAR_payx_owner: ${{ vars.PAYX_OWNER }}
      TF_VAR_payx_servicenow_group: ${{ vars.PAYX_SERVICENOW_GROUP }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/cli@v2
        with:
          inlineScript: |
            if [ "${{ github.event.inputs.environment }}" == "sandbox" ]; then
              az login --service-principal -u ${{ secrets.ARC_RUNNER_SP_CLIENT_ID_SANDBOX }} -p ${{ secrets.ARC_RUNNER_SP_CLIENT_SECRET_SANDBOX }} --tenant ${{ secrets.AZURE_TENANT_ID }}
              az account set --subscription "${{ secrets.AZURE_SANDBOX_SUBSCRIPTION_ID }}"
            else
              az login --service-principal -u ${{ secrets.ARC_RUNNER_SP_CLIENT_ID_NONPROD }} -p ${{ secrets.ARC_RUNNER_SP_CLIENT_SECRET_NONPROD }} --tenant ${{ secrets.AZURE_TENANT_ID }}
              az account set --subscription "${{ secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}"
            fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure Backend
        env:
          SANDBOX_SUB: ${{ secrets.AZURE_SANDBOX_SUBSCRIPTION_ID }}
          NONPROD_SUB: ${{ secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}
          PROD_SUB: ${{ secrets.AZURE_PROD_SUBSCRIPTION_ID }}
        run: |
          case "${{ github.event.inputs.environment }}" in
            sandbox)
              echo "TF_BACKEND_RG=rg-paychexai-tf-eastus-sandbox-001" >> $GITHUB_ENV
              echo "TF_BACKEND_SA=sapaychexaitfsb001" >> $GITHUB_ENV
              echo "TF_BACKEND_SUB=$SANDBOX_SUB" >> $GITHUB_ENV
              ;;
            n2a|n1)
              echo "TF_BACKEND_RG=rg-paychexai-tf-eastus-nonprod-001" >> $GITHUB_ENV
              echo "TF_BACKEND_SA=sapaychexaitfnonprod001" >> $GITHUB_ENV
              echo "TF_BACKEND_SUB=$NONPROD_SUB" >> $GITHUB_ENV
              ;;
            prod)
              echo "TF_BACKEND_RG=rg-paychexai-tf-eastus-prod-001" >> $GITHUB_ENV
              echo "TF_BACKEND_SA=sapaychexaitfprod001" >> $GITHUB_ENV
              echo "TF_BACKEND_SUB=$PROD_SUB" >> $GITHUB_ENV
              ;;
          esac

      - name: Init
        run: |
          terraform init \
            -backend-config="resource_group_name=$TF_BACKEND_RG" \
            -backend-config="storage_account_name=$TF_BACKEND_SA" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=librechat/${{ github.event.inputs.environment }}.tfstate" \
            -backend-config="subscription_id=$TF_BACKEND_SUB"

      - name: Plan
        id: plan
        run: |
          set +e
          terraform plan \
            -var-file=environments/${{ github.event.inputs.environment }}.tfvars \
            -out=deploy.tfplan \
            -detailed-exitcode
          exit_code=$?
          set -e

          if [ "$exit_code" == "1" ]; then
            echo "‚ùå Terraform plan failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "$exit_code" == "0" ]; then
            echo "‚ÑπÔ∏è No changes to apply" >> $GITHUB_STEP_SUMMARY
            echo "no_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Apply
        if: steps.plan.outputs.no_changes != 'true'
        run: terraform apply -auto-approve deploy.tfplan

      # Cross-subscription ACR role assignment for n2a
      # N2A container app in nonprod needs AcrPull on prod ACR
      - name: Grant ACR Pull (cross-subscription)
        if: |
          github.event.inputs.environment == 'n2a' &&
          steps.plan.outputs.no_changes != 'true' &&
          env.TF_VAR_first_deploy == 'true'
        run: |
          set -e

          # Get the managed identity principal ID from Terraform
          PRINCIPAL_ID=$(terraform output -raw container_app_identity_principal_id)
          if [ -z "$PRINCIPAL_ID" ]; then
            echo "‚ö†Ô∏è No principal ID found, skipping ACR role assignment"
            exit 0
          fi
          echo "Principal ID: $PRINCIPAL_ID"

          # Login to prod subscription
          echo "Logging into prod subscription..."
          az login --service-principal \
            -u ${{ secrets.ARC_RUNNER_SP_CLIENT_ID_PROD }} \
            -p ${{ secrets.ARC_RUNNER_SP_CLIENT_SECRET_PROD }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }} \
            --output none
          az account set --subscription ${{ secrets.AZURE_PROD_SUBSCRIPTION_ID }}

          # ACR scope (prod ACR shared by n2a, n1, prod environments)
          ACR_SCOPE="/subscriptions/${{ secrets.AZURE_PROD_SUBSCRIPTION_ID }}/resourceGroups/rg-paychexai-shared-eastus-prod-001/providers/Microsoft.ContainerRegistry/registries/conpaychexaiprod001"
          echo "ACR scope: $ACR_SCOPE"

          # Check if role assignment already exists
          EXISTING=$(az role assignment list --assignee "$PRINCIPAL_ID" --scope "$ACR_SCOPE" --role "AcrPull" --query "[0].id" -o tsv 2>/dev/null || echo "")
          if [ -n "$EXISTING" ]; then
            echo "‚úÖ AcrPull role assignment already exists"
          else
            echo "Creating AcrPull role assignment on prod ACR..."
            az role assignment create \
              --assignee-object-id "$PRINCIPAL_ID" \
              --assignee-principal-type ServicePrincipal \
              --role "AcrPull" \
              --scope "$ACR_SCOPE" \
              --output none
            echo "‚úÖ AcrPull role assignment created"
          fi

      # Always re-authenticate to nonprod after cross-subscription step
      - name: Re-authenticate to nonprod
        if: |
          github.event.inputs.environment == 'n2a' &&
          steps.plan.outputs.no_changes != 'true' &&
          env.TF_VAR_first_deploy == 'true'
        run: |
          az login --service-principal \
            -u ${{ secrets.ARC_RUNNER_SP_CLIENT_ID_NONPROD }} \
            -p ${{ secrets.ARC_RUNNER_SP_CLIENT_SECRET_NONPROD }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }} \
            --output none
          echo "‚úÖ Re-authenticated to nonprod"

      - name: Get URL
        id: get_url
        run: |
          URL=$(terraform output -raw application_url 2>/dev/null || echo "")
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Capture Outputs
        run: terraform output -json > outputs.json

      - name: Upload Outputs
        uses: actions/upload-artifact@v4
        with:
          name: outputs-${{ github.event.inputs.environment }}
          path: ${{ env.TF_WORKING_DIR }}/outputs.json
          retention-days: 30

      - name: Summary
        run: |
          echo "## ‚úÖ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed by** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Promotion Path" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "sandbox ‚Üí n2a ‚Üí n1 ‚Üí prod" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # DESTROY - Teardown infrastructure (heavily protected)
  # ============================================================================
  destroy-blocked:
    name: Destroy Blocked (${{ github.event.inputs.environment }})
    needs: validate
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'destroy' &&
      github.event.inputs.environment != 'sandbox' &&
      github.event.inputs.environment != 'n2a'
    runs-on: paychex-ai-platform-arc-sandbox
    steps:
      - name: Block Destroy
        run: |
          echo "::error::Destroy is currently blocked for ${{ github.event.inputs.environment }}."
          echo "::notice::Only sandbox and n2a environments can be destroyed via this workflow."
          echo ""
          echo "To destroy ${{ github.event.inputs.environment }}:"
          echo "  1. Update the workflow to allow destroy for this environment"
          echo "  2. Get approval from infrastructure team"
          exit 1

  destroy:
    name: Destroy (${{ github.event.inputs.environment }})
    needs: validate
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'destroy' &&
      (github.event.inputs.environment == 'sandbox' || github.event.inputs.environment == 'n2a')
    runs-on: ${{ github.event.inputs.environment == 'sandbox' && 'paychex-ai-platform-arc-sandbox' || (github.event.inputs.environment == 'prod' && 'paychex-ai-platform-arc-prod' || 'paychex-ai-platform-arc-nonprod') }}
    environment: ${{ github.event.inputs.environment }}-destroy
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}
    env:
      # Credentials mapped per environment
      ARM_SUBSCRIPTION_ID: ${{ github.event.inputs.environment == 'sandbox' && secrets.AZURE_SANDBOX_SUBSCRIPTION_ID || secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}
      ARM_CLIENT_ID: ${{ github.event.inputs.environment == 'sandbox' && secrets.ARC_RUNNER_SP_CLIENT_ID_SANDBOX || secrets.ARC_RUNNER_SP_CLIENT_ID_NONPROD }}
      ARM_CLIENT_SECRET: ${{ github.event.inputs.environment == 'sandbox' && secrets.ARC_RUNNER_SP_CLIENT_SECRET_SANDBOX || secrets.ARC_RUNNER_SP_CLIENT_SECRET_NONPROD }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      TF_VAR_subscription_id: ${{ github.event.inputs.environment == 'sandbox' && secrets.AZURE_SANDBOX_SUBSCRIPTION_ID || secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}
      # First deploy flag - defaults to false (production-safe), set <ENV>_FIRST_DEPLOY=true to enable relaxed settings
      TF_VAR_first_deploy: ${{ (github.event.inputs.environment == 'sandbox' && vars.SANDBOX_FIRST_DEPLOY == 'true') || (github.event.inputs.environment == 'n2a' && vars.N2A_FIRST_DEPLOY == 'true') || (github.event.inputs.environment == 'n1' && vars.N1_FIRST_DEPLOY == 'true') || (github.event.inputs.environment == 'prod' && vars.PROD_FIRST_DEPLOY == 'true') }}
      # Paychex tags - from GitHub repository variables
      TF_VAR_payx_owner: ${{ vars.PAYX_OWNER }}
      TF_VAR_payx_servicenow_group: ${{ vars.PAYX_SERVICENOW_GROUP }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/cli@v2
        with:
          inlineScript: |
            if [ "${{ github.event.inputs.environment }}" == "sandbox" ]; then
              az login --service-principal -u ${{ secrets.ARC_RUNNER_SP_CLIENT_ID_SANDBOX }} -p ${{ secrets.ARC_RUNNER_SP_CLIENT_SECRET_SANDBOX }} --tenant ${{ secrets.AZURE_TENANT_ID }}
              az account set --subscription "${{ secrets.AZURE_SANDBOX_SUBSCRIPTION_ID }}"
            else
              az login --service-principal -u ${{ secrets.ARC_RUNNER_SP_CLIENT_ID_NONPROD }} -p ${{ secrets.ARC_RUNNER_SP_CLIENT_SECRET_NONPROD }} --tenant ${{ secrets.AZURE_TENANT_ID }}
              az account set --subscription "${{ secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}"
            fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure Backend
        env:
          SANDBOX_SUB: ${{ secrets.AZURE_SANDBOX_SUBSCRIPTION_ID }}
          NONPROD_SUB: ${{ secrets.AZURE_NONPROD_SUBSCRIPTION_ID }}
          PROD_SUB: ${{ secrets.AZURE_PROD_SUBSCRIPTION_ID }}
        run: |
          case "${{ github.event.inputs.environment }}" in
            sandbox)
              echo "TF_BACKEND_RG=rg-paychexai-tf-eastus-sandbox-001" >> $GITHUB_ENV
              echo "TF_BACKEND_SA=sapaychexaitfsb001" >> $GITHUB_ENV
              echo "TF_BACKEND_SUB=$SANDBOX_SUB" >> $GITHUB_ENV
              ;;
            n2a|n1)
              echo "TF_BACKEND_RG=rg-paychexai-tf-eastus-nonprod-001" >> $GITHUB_ENV
              echo "TF_BACKEND_SA=sapaychexaitfnonprod001" >> $GITHUB_ENV
              echo "TF_BACKEND_SUB=$NONPROD_SUB" >> $GITHUB_ENV
              ;;
            prod)
              echo "TF_BACKEND_RG=rg-paychexai-tf-eastus-prod-001" >> $GITHUB_ENV
              echo "TF_BACKEND_SA=sapaychexaitfprod001" >> $GITHUB_ENV
              echo "TF_BACKEND_SUB=$PROD_SUB" >> $GITHUB_ENV
              ;;
          esac

      - name: Init
        run: |
          terraform init \
            -backend-config="resource_group_name=$TF_BACKEND_RG" \
            -backend-config="storage_account_name=$TF_BACKEND_SA" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=librechat/${{ github.event.inputs.environment }}.tfstate" \
            -backend-config="subscription_id=$TF_BACKEND_SUB"

      - name: Plan Destroy
        run: |
          terraform plan \
            -var-file=environments/${{ github.event.inputs.environment }}.tfvars \
            -destroy \
            -out=destroy.tfplan

      - name: Destroy
        run: terraform apply -auto-approve destroy.tfplan

      - name: Summary
        run: |
          echo "## üóëÔ∏è Environment Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Destroyed by** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Note:** State file retained for audit purposes" >> $GITHUB_STEP_SUMMARY
